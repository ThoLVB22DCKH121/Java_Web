<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý bất động sản</title>
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/admin_chat.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<div class="container-fluid">
    <!-- Header -->
    <div th:replace="fragments/header_admin :: div"></div>

    <div class="row" style="margin-top: 60px">
        <!-- Sidebar -->
        <div class="col-md-2">
            <div th:replace="fragments/sidebar_admin :: div"></div>
        </div>

        <!-- Nội dung chính -->
        <div class="col-md-10 content">
            <h3>Quản lý chat</h3>
            <!-- Main Content -->
            <div class="main-content">
                <div class="container chat-container">
                    <!-- User List -->
                    <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action" th:each="user : ${users}" th:attr="data-username=${user.username}" onclick="openChat(event, this)">
                            <span th:text="${user.username}"></span>
                        </a>
                    </div>

                    <!-- Chat Windows -->
                    <div class="row g-4" id="chat-container" th:each="user : ${users}">
                        <div class="col">
                            <div class="chat-frame" th:id="'chat-' + ${user.username}">
                                <div class="chat-header" th:attr="onclick='closeChat(\'' + ${user.username} + '\')'">
                                    <h5 th:text="${user.username}"></h5>
                                </div>
                                <div class="message-list" th:id="'messages-' + ${user.username}"></div>
                                <div class="input-group">
                                    <input class="form-control" th:id="'messageInput-' + ${user.username}" type="text" placeholder="Type a message...">
                                    <button type="button" class="btn btn-primary" th:attr="onclick='sendMessageToUser(\'' + ${user.username} + '\', event)'">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var users = /*[[${users}]]*/ [];
    console.log("Loaded users:", users);

    var socket = new SockJS('http://localhost:8081/ws');
    var stompClient = Stomp.over(socket);
    var adminUsername = "admin";

    stompClient.connect({}, function (frame) {
        console.log("WebSocket connected as: " + adminUsername);

        stompClient.subscribe('/user/' + adminUsername + '/queue/messages', function (message) {
            console.log("Admin subscribed to /user/" + adminUsername + "/queue/messages");
            var msg = JSON.parse(message.body);
            console.log("Admin received message:", msg);
            if (msg.senderUsername !== adminUsername) {
                showMessageInChannel(msg.channel, msg);
            }
        });

        // Tải lịch sử chat cho tất cả user
        users.forEach(user => {
            if (!user.username) {
                console.error("User object missing username:", user);
                return;
            }
            fetchChatHistory(user.username);
        });
    }, function (error) {
        console.error("WebSocket connection error:", error);
    });

    function sendMessageToUser(username, event) {
        event.preventDefault();
        var messageContent = document.getElementById('messageInput-' + username).value;
        if (messageContent.trim()) {
            var message = {
                senderUsername: adminUsername,
                recipient: username,
                content: messageContent,
                channel: 'chat-' + username
            };
            console.log("Admin sending message:", message);

            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(message));

            showMessageInChannel('chat-' + username, message);

            document.getElementById('messageInput-' + username).value = '';
        }
    }

    function showMessageInChannel(channel, message) {
        var username = channel.split('-')[1];
        var messagesDiv = document.getElementById('messages-' + username);
        console.log("Showing message in channel:", channel, "for username:", username, "messagesDiv:", messagesDiv);
        if (messagesDiv) {
            var messageClass = (message.senderUsername === adminUsername) ? 'sent' : 'received';
            console.log("Showing message with class:", messageClass, "content:", message.content);
            messagesDiv.innerHTML += `
                    <div class="message ${messageClass}">
                        <div class="message-bubble">${message.content}</div>
                    </div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } else {
            console.error("Messages div not found for username:", username);
        }
    }

    function openChat(event, element) {
        event.preventDefault();
        var username = element.getAttribute("data-username");
        document.querySelectorAll(".chat-frame").forEach(chat => chat.style.display = "none");
        var chatFrame = document.getElementById("chat-" + username);
        chatFrame.style.display = "block";
        fetchChatHistory(username);
    }

    function closeChat(username) {
        document.getElementById("chat-" + username).style.display = "none";
    }

    function fetchChatHistory(username) {
        fetch('http://localhost:8081/api/chat/history/chat-' + username)
            .then(response => response.json())
            .then(history => {
                console.log("Fetched chat history for user:", username, history);
                var messagesDiv = document.getElementById('messages-' + username);
                messagesDiv.innerHTML = '';
                history.forEach(msg => showMessageInChannel('chat-' + username, msg));
            })
            .catch(error => console.error("Error fetching chat history:", error));
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>